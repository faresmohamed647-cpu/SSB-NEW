<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/QR.css">
    <title>QR</title>
</head>
<body>
    <div class="container">
        <label for="qr text">Enter Text or URL</label>
        <input type="text"id="qr text" placeholder=" Text or URL" required>
        <div id="qrContainer"></div>

        <button type="button" class="button"id="genbutton">Generate QR Code</button>
        <a href="" class="button" id="downloadBTN" download="qrcode.jpg">Download QR Code student</a>

    </div>
    
    


</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.js"></script>
<script>
    let qrContainer = document.getElementById("qrContainer");
    let qrText = document.getElementById("qr text");
    let genbutton = document.getElementById("genbutton");
    let downloadBTN = document.getElementById("downloadBTN");
    let qrImage;
    let blobUrl = null; // متغير لتخزين رابط الـ blob

    // دالة تحويل base64 إلى blob URL (لضمان التحميل في جميع المتصفحات)
    function base64ToBlobUrl(base64Data) {
        const byteCharacters = atob(base64Data.split(',')[1]); // فك التشفير
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/png' });
        return URL.createObjectURL(blob); // إنشاء رابط مؤقت للتحميل
    }

    // دالة توليد QR code (مصححة لتجنب إفساد qrContainer)
    generateQR = (qrText) => {
        qrContainer.innerHTML = ""; // مسح المحتوى السابق
        return new QRCode(qrContainer, {
            text: qrText,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    }

    // دالة تحميل QR code (مصححة مع تحويل base64 إلى blob)
    downloadQR = () => {
        qrImage = document.querySelector("#qrContainer img");
        if (qrImage) {
            let imgSrc = qrImage.getAttribute("src"); // إصلاح الإملاء
            console.log(imgSrc);
            // تحويل base64 إلى blob URL للتحميل الفعلي
            blobUrl = base64ToBlobUrl(imgSrc);
            downloadBTN.setAttribute("href", blobUrl); // إصلاح الإملاء
        } else {
            alert("No QR code generated yet! Please generate one first.");
        }
    }

    // حدث النقر على زر التوليد (مصحح لتجنب التكرار والإفساد)
    genbutton.addEventListener("click", (e) => {
        let text = qrText.value.trim(); // إزالة المسافات الزائدة
        if (text.length > 0) {
            generateQR(text); // توليد QR code مرة واحدة فقط
            qrContainer.classList.add('img-show');
            downloadBTN.classList.add('download-active');
        } else {
            alert("Please enter some text or URL!");
        }
    });

    // حدث النقر على زر التحميل
    downloadBTN.addEventListener("click", downloadQR);

    
</script>


</html>